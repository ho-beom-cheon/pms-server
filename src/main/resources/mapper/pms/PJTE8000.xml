<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.iteyes.mapper.pms.PJTE8000Mapper">
    <select id="select_8000_01" parameterType="Map" resultType="com.iteyes.dto.pms.PJTE8000DTO">
        SELECT 		B.DTLS_TYCD1 AS REAL_PRJT_ID
             , B.BKUP_ID AS BKUP_ID
             , B.ETC_TXT1 AS START_PRJT_DATE
             , B.ETC_TXT2 AS END_PRJT_DATE
             , B.DTLS_TYNM1 AS REAL_PRJT_NM
             , C.EMPNM AS PM_NM
             , A.PM_NO
             , A.WEEK_YYMM
             , B.DTLS_TYCD2 AS WEEK_SQN_CD
             , A.DEPT_CD
             , F.DTLS_TYNM AS DEPT_NM
             , B.DTLS_TYNM2 AS WEEK_SQN_NM
             , A.ALL_REAL_PRG
             , A.ALL_PRED_PRG
             , A.STEP_NM
             , A.STEP_REAL_PRG
             , A.STEP_PRED_PRG
             , A.PRG_TXT
             , A.ISS_TXT
             , A.REQ_TXT
             , F1.ORG_FILE_NM
             , A.ATFL_MNG_ID
             , G.EMPNM          AS BEF_PM_NM
             , E.PM_NO	        AS BEF_PM_NO
             , E.WEEK_YYMM	    AS BEF_WEEK_YYMM
             , E.WEEK_SQN_CD    AS BEF_WEEK_SQN_CD
             , H.DTLS_TYNM      AS BEF_WEEK_SQN_NM
             , E.ALL_REAL_PRG	AS BEF_ALL_REAL_PRG
             , E.ALL_PRED_PRG	AS BEF_ALL_PRED_PRG
             , E.STEP_NM	    AS BEF_STEP_NM
             , E.STEP_REAL_PRG	AS BEF_STEP_REAL_PRG
             , E.STEP_PRED_PRG	AS BEF_STEP_PRED_PRG
             , E.PRG_TXT	    AS BEF_PRG_TXT
             , E.ISS_TXT	    AS BEF_ISS_TXT
             , E.REQ_TXT	    AS BEF_REQ_TXT
             , F2.ORG_FILE_NM AS BEF_ORG_FILE_NM
             , E.ATFL_MNG_ID	AS BEF_ATFL_MNG_ID
          FROM (SELECT A.BKUP_ID
                     , A.PRJT_ID
                     , A.REAL_PRJT_ID
                     , A.PM_NO
                     , A.DEPT_CD
                     , A.WEEK_YYMM
                     , A.WEEK_SQN_CD
                     , A.ALL_REAL_PRG
                     , A.ALL_PRED_PRG
                     , A.STEP_NM
                     , A.STEP_REAL_PRG
                     , A.STEP_PRED_PRG
                     , A.PRG_TXT
                     , A.ISS_TXT
                     , A.REQ_TXT
                     , A.ATFL_MNG_ID
                     , (SELECT MAX(CONCAT(S.WEEK_YYMM,S.WEEK_SQN_CD))
                          FROM pms_week_rpt_mng S
                         WHERE  1 = 1
                 <![CDATA[ AND    CONCAT(S.WEEK_YYMM,S.WEEK_SQN_CD) < CONCAT(A.WEEK_YYMM,A.WEEK_SQN_CD)]]>
                           AND    S.REAL_PRJT_ID = A.REAL_PRJT_ID
                           AND    S.PRJT_ID      = A.PRJT_ID
                           AND    S.BKUP_ID      = A.BKUP_ID
                        ) AS REAL_PRJT_KEY
                  FROM  pms_week_rpt_mng A
                 WHERE 1 = 1
                   AND A.BKUP_ID = '0000000000'
                   <if test='week_yymm != "" and week_yymm != null'>
                   AND    A.WEEK_YYMM LIKE CONCAT(REPLACE(#{week_yymm},'-',''),'%')
                   </if>
                 ) A
        RIGHT OUTER JOIN
        (SELECT A.BKUP_ID
              , A.PRJT_ID
              , A.DTLS_TYCD AS DTLS_TYCD1
              , A.ETC_TXT1
              , A.ETC_TXT2
              , A.DTLS_TYNM AS DTLS_TYNM1
              , B.DTLS_TYNM AS DTLS_TYNM2
              , B.DTLS_TYCD AS DTLS_TYCD2
           FROM(SELECT *
                  FROM pms_cd_del_mng
                 WHERE GRP_TYCD   = '1000000038'
                   AND PRJT_ID ='0000000001') A
                 LEFT OUTER JOIN
                       pms_cd_del_mng B
                   ON A.PRJT_ID=B.PRJT_ID
                  AND B.GRP_TYCD   = '1000000039'
                  AND B.PRJT_ID ='0000000001'
        ) B
        ON  A.PRJT_ID = B.PRJT_ID
        AND A.REAL_PRJT_ID = B.DTLS_TYCD1
        AND A.WEEK_SQN_CD = B.DTLS_TYCD2
        LEFT OUTER JOIN
        pms_emp_info  C
        ON  C.EMPNO      = A.PM_NO
        AND C.PRJT_ID    = A.PRJT_ID
        AND C.BKUP_ID    = A.BKUP_ID
        LEFT OUTER JOIN
        pms_cd_del_mng   F
        ON  F.DTLS_TYCD  = A.DEPT_CD
        AND F.GRP_TYCD   = '1000000040'
        AND F.PRJT_ID    = A.PRJT_ID
        AND F.BKUP_ID    = A.BKUP_ID
        LEFT OUTER JOIN
        pms_atfl_mng   F1
        ON  F1.SQNO          = 1
        AND F1.FILE_RGS_DSCD = '800'
        AND F1.ATFL_MNG_ID   = A.ATFL_MNG_ID
        AND F1.PRJT_ID       = A.PRJT_ID
        AND F1.BKUP_ID       = A.BKUP_ID
        LEFT OUTER JOIN
        pms_week_rpt_mng   E
        ON  E.WEEK_SQN_CD  = SUBSTR(A.REAL_PRJT_KEY,7,3)
        AND E.WEEK_YYMM    = SUBSTR(A.REAL_PRJT_KEY,1,6)
        AND E.REAL_PRJT_ID = A.REAL_PRJT_ID
        AND  E.PRJT_ID      = A.PRJT_ID
        AND  E.BKUP_ID      = A.BKUP_ID
        LEFT OUTER JOIN
        pms_emp_info  G
        ON  G.EMPNO      = E.PM_NO
        AND G.PRJT_ID    = E.PRJT_ID
        AND G.BKUP_ID    = E.BKUP_ID
        LEFT OUTER JOIN
        pms_cd_del_mng   H
        ON  H.DTLS_TYCD  = E.WEEK_SQN_CD
        AND H.GRP_TYCD   = '1000000039'
        AND H.PRJT_ID    = E.PRJT_ID
        AND H.BKUP_ID    = E.BKUP_ID
        LEFT OUTER JOIN
        pms_atfl_mng   F2
        ON  F2.SQNO          = 1
        AND F2.FILE_RGS_DSCD = '800'
        AND F2.ATFL_MNG_ID   = E.ATFL_MNG_ID
        AND F2.PRJT_ID       = E.PRJT_ID
        AND F2.BKUP_ID       = E.BKUP_ID
        WHERE 1=1
        AND   B.DTLS_TYCD1 = CASE WHEN  #{real_prjt_id}  = 'TTT' THEN  B.DTLS_TYCD1  ELSE  #{real_prjt_id}  END
        AND   B.DTLS_TYCD2 = CASE WHEN #{week_sqn_cd} = 'TTT' THEN B.DTLS_TYCD2 ELSE #{week_sqn_cd} END
        <if test='dept_cd != "TTT"'>
            AND   A.DEPT_CD = CASE WHEN #{dept_cd} = 'TTT' THEN A.DEPT_CD ELSE #{dept_cd} END
        </if>
        <if test='pm_no != "" and pm_no != null'>
            AND    A.PM_NO = #{pm_no}
        </if>
        ORDER BY B.DTLS_TYCD1 DESC, B.DTLS_TYCD2 ASC,A.WEEK_YYMM DESC
    </select>

    <select id="select_8000_02" parameterType="Map" resultType="com.iteyes.dto.pms.PJTE8000DTO">
        SELECT G.EMPNM          AS BEF_PM_NM
             , E.PM_NO	        AS BEF_PM_NO
             , E.DEPT_CD        AS DEPT_CD
             , E.WEEK_YYMM	    AS BEF_WEEK_YYMM
             , E.WEEK_SQN_CD    AS BEF_WEEK_SQN_CD
             , H.DTLS_TYNM      AS BEF_WEEK_SQN_NM
             , E.ALL_REAL_PRG	AS BEF_ALL_REAL_PRG
             , E.ALL_PRED_PRG	AS BEF_ALL_PRED_PRG
             , E.STEP_NM	    AS BEF_STEP_NM
             , E.STEP_REAL_PRG	AS BEF_STEP_REAL_PRG
             , E.STEP_PRED_PRG	AS BEF_STEP_PRED_PRG
             , E.PRG_TXT	    AS BEF_PRG_TXT
             , E.ISS_TXT	    AS BEF_ISS_TXT
             , E.REQ_TXT	    AS BEF_REQ_TXT
             , E.ATFL_MNG_ID	AS BEF_ATFL_MNG_ID
             , I.ORG_FILE_NM    AS BEF_ORG_FILE_NM
          FROM   pms_week_rpt_mng   E
                 LEFT OUTER JOIN
                      pms_emp_info  G
                     ON  G.EMPNO      = E.PM_NO
                     AND G.PRJT_ID    = E.PRJT_ID
                     AND G.BKUP_ID    = E.BKUP_ID
                 LEFT OUTER JOIN
                      pms_cd_del_mng   H
                    ON  H.DTLS_TYCD  = E.WEEK_SQN_CD
                    AND H.GRP_TYCD   = '1000000039'
                    AND H.PRJT_ID    = E.PRJT_ID
                    AND H.BKUP_ID    = E.BKUP_ID
                 LEFT OUTER JOIN
                 pms_atfl_mng   I
                     ON  I.SQNO          = 1
                     AND I.FILE_RGS_DSCD = '800'
                     AND I.ATFL_MNG_ID  = E.ATFL_MNG_ID
                     AND I.PRJT_ID      = E.PRJT_ID
                     AND I.BKUP_ID      = E.BKUP_ID
         WHERE  E.WEEK_SQN_CD  = (SELECT SUBSTR(MAX(CONCAT(A.WEEK_YYMM,A.WEEK_SQN_CD)),7,3)
                                    FROM   pms_week_rpt_mng A
                                   WHERE  <![CDATA[ CONCAT(A.WEEK_YYMM,A.WEEK_SQN_CD) < CONCAT(#{week_yymm},#{week_sqn_cd}) ]]>
                                     AND    A.REAL_PRJT_ID = E.REAL_PRJT_ID
                                     AND    A.PRJT_ID      = E.PRJT_ID
                                     AND    A.BKUP_ID      = E.BKUP_ID)
           AND    E.WEEK_YYMM    = (SELECT SUBSTR(MAX(CONCAT(A.WEEK_YYMM,A.WEEK_SQN_CD)),1,6)
                                      FROM   pms_week_rpt_mng A
                                     WHERE  <![CDATA[ CONCAT(A.WEEK_YYMM,A.WEEK_SQN_CD) < CONCAT(#{week_yymm},#{week_sqn_cd}) ]]>
                                       AND    A.REAL_PRJT_ID = E.REAL_PRJT_ID
                                       AND    A.PRJT_ID      = E.PRJT_ID
                                       AND    A.BKUP_ID      = E.BKUP_ID)
           AND    E.REAL_PRJT_ID = #{real_prjt_id}
           AND    E.BKUP_ID      = '0000000000'
    </select>
    <insert id="insert_8000_01" parameterType="Map" >
    INSERT INTO pms_week_rpt_mng
    (
     BKUP_ID
    ,PRJT_ID
    ,REAL_PRJT_ID
    ,WEEK_YYMM
    ,WEEK_SQN_CD
    ,DEPT_CD
    ,PM_NO
    ,ALL_REAL_PRG
    ,ALL_PRED_PRG
    ,STEP_NM
    ,STEP_REAL_PRG
    ,STEP_PRED_PRG
    ,PRG_TXT
    ,ISS_TXT
    ,REQ_TXT
    ,ATFL_MNG_ID
    ,OPR_NO
    ,DB_CHG_TS
    )
    VALUES
    (
    '0000000000'
    , #{prjt_id}
    , #{real_prjt_id}
    , REPLACE(#{week_yymm},'-','')
    , #{week_sqn_cd}
    , #{dept_cd}
    , #{pm_no}
    , #{all_real_prg}
    , #{all_pred_prg}
    , #{step_nm}
    , #{step_real_prg}
    , #{step_pred_prg}
    , #{prg_txt}
    , #{iss_txt}
    , #{req_txt}
    , #{atfl_mng_id}
    , #{login_emp_no}
    , DATE_FORMAT(NOW(),'%Y%m%d%H%i%s')
    )
    </insert>

    <update id="update_8000_01" parameterType="Map" >
        UPDATE pms_week_rpt_mng
        SET    PM_NO	       = #{pm_no}
          ,ALL_REAL_PRG	 = #{all_real_prg}
          ,ALL_PRED_PRG	 = #{all_pred_prg}
          ,STEP_NM	     = #{step_nm}
          ,STEP_REAL_PRG = #{step_real_prg}
          ,STEP_PRED_PRG = #{step_pred_prg}
          ,PRG_TXT	     = #{prg_txt}
          ,ISS_TXT	     = #{iss_txt}
          ,REQ_TXT	     = #{req_txt}
          ,ATFL_MNG_ID   = #{atfl_mng_id}
          ,OPR_NO        = #{login_emp_no}
          ,DB_CHG_TS     = DATE_FORMAT(NOW(),'%Y%m%d%H%i%s')
        WHERE  1 = 1
          AND    WEEK_SQN_CD     = #{week_sqn_cd}
          AND    WEEK_YYMM       = REPLACE(#{week_yymm},'-','')
          AND    REAL_PRJT_ID	 = #{real_prjt_id}
          AND    DEPT_CD         = #{dept_cd}
          AND    PRJT_ID         = '0000000001'
          AND    BKUP_ID	     = '0000000000'
    </update>
</mapper>