<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.iteyes.mapper.pms.PJTE8000Mapper">
    <select id="select_8000_01" parameterType="Map" resultType="com.iteyes.dto.pms.PJTE8000DTO">
        SELECT A.REAL_PRJT_ID
             , A.BKUP_ID AS BKUP_ID
             , B.DTLS_TYNM AS REAL_PRJT_NM
             , C.EMPNM AS PM_NM
             , A.PM_NO
             , A.WEEK_YYMM
             , A.WEEK_SQN_CD
             , A.DEPT_CD
             , D.DTLS_TYNM AS WEEK_SQN_NM
             , A.ALL_REAL_PRG
             , A.ALL_PRED_PRG
             , A.STEP_NM
             , A.STEP_REAL_PRG
             , A.STEP_PRED_PRG
             , A.PRG_TXT
             , A.ISS_TXT
             , A.REQ_TXT
             , F1.ORG_FILE_NM
             , A.ATFL_MNG_ID
             , G.EMPNM          AS BEF_PM_NM
             , E.PM_NO	        AS BEF_PM_NO
             , E.WEEK_YYMM	    AS BEF_WEEK_YYMM
             , E.WEEK_SQN_CD    AS BEF_WEEK_SQN_CD
             , H.DTLS_TYNM      AS BEF_WEEK_SQN_NM
             , E.ALL_REAL_PRG	AS BEF_ALL_REAL_PRG
             , E.ALL_PRED_PRG	AS BEF_ALL_PRED_PRG
             , E.STEP_NM	    AS BEF_STEP_NM
             , E.STEP_REAL_PRG	AS BEF_STEP_REAL_PRG
             , E.STEP_PRED_PRG	AS BEF_STEP_PRED_PRG
             , E.PRG_TXT	    AS BEF_PRG_TXT
             , E.ISS_TXT	    AS BEF_ISS_TXT
             , E.REQ_TXT	    AS BEF_REQ_TXT
             , F2.ORG_FILE_NM AS BEF_ORG_FILE_NM
             , E.ATFL_MNG_ID	AS BEF_ATFL_MNG_ID
          FROM (SELECT A.BKUP_ID
                     , A.PRJT_ID
                     , A.REAL_PRJT_ID
                     , A.PM_NO
                     , A.DEPT_CD
                     , A.WEEK_YYMM
                     , A.WEEK_SQN_CD
                     , A.ALL_REAL_PRG
                     , A.ALL_PRED_PRG
                     , A.STEP_NM
                     , A.STEP_REAL_PRG
                     , A.STEP_PRED_PRG
                     , A.PRG_TXT
                     , A.ISS_TXT
                     , A.REQ_TXT
                     , A.ATFL_MNG_ID
                     , (SELECT MAX(CONCAT(S.WEEK_YYMM,S.WEEK_SQN_CD))
                          FROM pms_week_rpt_mng S
                         WHERE  1 = 1
                        <![CDATA[ AND    CONCAT(S.WEEK_YYMM,S.WEEK_SQN_CD) < CONCAT(A.WEEK_YYMM,A.WEEK_SQN_CD)]]>
                           AND    S.REAL_PRJT_ID = A.REAL_PRJT_ID
                           AND    S.PRJT_ID      = A.PRJT_ID
                           AND    S.BKUP_ID      = A.BKUP_ID
                       ) AS REAL_PRJT_KEY
                  FROM  pms_week_rpt_mng A
                 WHERE 1 = 1
                   AND   A.BKUP_ID = '0000000000'
                   AND   A.REAL_PRJT_ID = CASE WHEN #{real_prjt_id} = 'TTT' THEN A.REAL_PRJT_ID ELSE #{real_prjt_id} END
                   AND   A.WEEK_SQN_CD = CASE WHEN #{week_sqn_cd} = 'TTT' THEN A.WEEK_SQN_CD ELSE #{week_sqn_cd} END
                   AND   A.DEPT_CD = CASE WHEN #{dept_cd} = 'TTT' THEN A.DEPT_CD ELSE #{dept_cd} END
                   <if test='week_yymm != "" and week_yymm != null'>
                   AND    A.WEEK_YYMM LIKE CONCAT(REPLACE(#{week_yymm},'-',''),'%')
                   </if>
                   <if test='pm_no != "" and pm_no != null'>
                   AND    A.PM_NO = #{pm_no}
                   </if>
                ) A
                LEFT OUTER JOIN
                pms_cd_del_mng   B
                ON  B.DTLS_TYCD  = A.REAL_PRJT_ID
                AND B.GRP_TYCD   = '1000000038'
                AND B.PRJT_ID    = A.PRJT_ID
                AND B.BKUP_ID    = A.BKUP_ID
                LEFT OUTER JOIN
                pms_emp_info  C
                ON  C.EMPNO      = A.PM_NO
                AND C.PRJT_ID    = A.PRJT_ID
                AND C.BKUP_ID    = A.BKUP_ID
                LEFT OUTER JOIN
                pms_cd_del_mng   D
                ON  D.DTLS_TYCD  = A.WEEK_SQN_CD
                AND D.GRP_TYCD   = '1000000039'
                AND D.PRJT_ID    = A.PRJT_ID
                AND D.BKUP_ID    = A.BKUP_ID
                LEFT OUTER JOIN
                pms_cd_del_mng   F
                ON  B.DTLS_TYCD  = A.DEPT_CD
                AND B.GRP_TYCD   = '1000000040'
                AND B.PRJT_ID    = A.PRJT_ID
                AND B.BKUP_ID    = A.BKUP_ID
                LEFT OUTER JOIN
                pms_atfl_mng   F1
                ON  F1.SQNO          = 1
                AND F1.FILE_RGS_DSCD = '800'
                AND F1.ATFL_MNG_ID   = A.ATFL_MNG_ID
                AND F1.PRJT_ID       = A.PRJT_ID
                AND F1.BKUP_ID       = A.BKUP_ID
                LEFT OUTER JOIN
                pms_week_rpt_mng   E
                ON  E.WEEK_SQN_CD  = SUBSTR(A.REAL_PRJT_KEY,7,3)
                AND E.WEEK_YYMM    = SUBSTR(A.REAL_PRJT_KEY,1,6)
                AND E.REAL_PRJT_ID = A.REAL_PRJT_ID
                AND  E.PRJT_ID      = A.PRJT_ID
                AND  E.BKUP_ID      = A.BKUP_ID
                LEFT OUTER JOIN
                pms_emp_info  G
                ON  G.EMPNO      = E.PM_NO
                AND G.PRJT_ID    = E.PRJT_ID
                AND G.BKUP_ID    = E.BKUP_ID
                LEFT OUTER JOIN
                pms_cd_del_mng   H
                ON  H.DTLS_TYCD  = E.WEEK_SQN_CD
                AND H.GRP_TYCD   = '1000000039'
                AND H.PRJT_ID    = E.PRJT_ID
                AND H.BKUP_ID    = E.BKUP_ID
                LEFT OUTER JOIN
                pms_atfl_mng   F2
                ON  F2.SQNO          = 1
                AND F2.FILE_RGS_DSCD = '800'
                AND F2.ATFL_MNG_ID   = E.ATFL_MNG_ID
                AND F2.PRJT_ID       = E.PRJT_ID
                AND F2.BKUP_ID       = E.BKUP_ID
        ORDER BY A.WEEK_YYMM DESC, A.WEEK_SQN_CD DESC, A.REAL_PRJT_ID DESC
    </select>
</mapper>