<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.iteyes.mapper.pms.PJTE8100Mapper">
    <select id="select_8100_01" parameterType="Map" resultType="com.iteyes.dto.pms.PJTE8100DTO">
        SELECT
        CASE WHEN A.RSR_DT IS NOT NULL AND A.RSR_DT != ''
        THEN STR_TO_DATE(A.RSR_DT, '%Y%m%d') ELSE A.RSR_DT
        END AS RSR_DT
        ,CONCAT(SUBSTR(A.RSRV_STRT,1,2),':',SUBSTR(A.RSRV_STRT,3,2)) AS RSRV_STRT_NM
        ,CONCAT(SUBSTR(A.RSRV_ENDT,1,2),':',SUBSTR(A.RSRV_ENDT,3,2)) AS RSRV_ENDT_NM
        ,B.DTLS_TYNM AS MTNG_ROOM_NM
        ,A.MTNG_TTL
        ,C.EMPNM AS RSR_NM
        ,D.ORG_FILE_NM
        ,A.BKUP_ID
        ,A.PRJT_ID
        ,A.MTNG_ROOM_ID
        ,A.SQNO
        ,A.RSR_NO
        ,A.ATFL_MNG_ID
        ,A.RSRV_STRT
        ,A.RSRV_ENDT
        FROM   pms_mtng_room_mng A
        LEFT OUTER JOIN
        pms_cd_del_mng   B
        ON  B.DTLS_TYCD  = A.MTNG_ROOM_ID
        AND B.GRP_TYCD   = '1000000047'
        AND B.PRJT_ID    = A.PRJT_ID
        AND B.BKUP_ID    = A.BKUP_ID
        LEFT OUTER JOIN
        pms_emp_info   C
        ON  C.EMPNO      = A.RSR_NO
        AND C.PRJT_ID    = A.PRJT_ID
        AND C.BKUP_ID    = A.BKUP_ID
        LEFT OUTER JOIN
        pms_atfl_mng   D
        ON  D.SQNO          = 1
        AND D.FILE_RGS_DSCD = '803'
        AND D.ATFL_MNG_ID   = A.ATFL_MNG_ID
        AND D.PRJT_ID       = A.PRJT_ID
        AND D.BKUP_ID       = A.BKUP_ID
        WHERE  A.BKUP_ID      = '0000000000'
        AND    A.PRJT_ID      = #{prjt_id}
        <if test='mtng_room_id != "" and mtng_room_id != null and mtng_room_id != "TTT"'>
            AND    A.MTNG_ROOM_ID = #{mtng_room_id}
        </if>
        <if test='rsr_strt != ""  and rsr_strt != null and rsr_endt != ""  and rsr_endt != null'>
            AND    A.RSR_DT       BETWEEN REPLACE(#{rsr_strt}, '-', '') AND REPLACE(#{rsr_endt}, '-', '')
        </if>
        <if test='rsr_no != "" and rsr_no != null'>
            AND    A.RSR_NO       = #{rsr_no}
        </if>
        ORDER BY A.RSR_DT, A.MTNG_ROOM_ID, A.RSRV_STRT
    </select>

    <update id="update_8100_01" parameterType="Map">
        UPDATE pms_mnts_mng
        SET    CNF_WEK      = #{cnf_wek}
          ,MTN_DT      = REPLACE(#{mtn_dt}, '-', '')
          ,MTN_TM   = #{mtn_tm}
          ,MTN_PLC   = #{mtn_plc}
          ,ATHR_NO    = #{athr_no}
          ,MTN_DTL    = #{mtn_dtl}
          ,MTN_RSL    = #{mtn_rsl}
          ,RQS_DTL    = #{rqs_dtl}
          ,ATND_DTL    = #{atnd_dtl}
          ,OPR_NO      = #{login_emp_no}
          ,DB_CHG_TS   = DATE_FORMAT(NOW(),'%Y%m%d%H%i%s')
        WHERE  1 = 1
          AND    BKUP_ID      = '0000000000'
          AND    PRJT_ID      = #{prjt_id}
          AND    MNG_ID = #{mng_id}
    </update>

    <update id="update_8100_02" parameterType="Map">
        UPDATE pms_mnts_mng
        SET    DEL_YN      = 'Y'
          ,OPR_NO      = #{login_emp_no}
          ,DB_CHG_TS   = DATE_FORMAT(NOW(),'%Y%m%d%H%i%s')
        WHERE  1 = 1
          AND    BKUP_ID      = '0000000000'
          AND    PRJT_ID      = #{prjt_id}
          AND    MNG_ID = #{mng_id}
    </update>

    <insert id="insert_8100_01" parameterType="Map">
        <selectKey resultType = "string" keyProperty="mng_id" order="BEFORE">
            SELECT NVL(MAX(CAST(MNG_ID AS INT))+1,'1000000000') AS MNG_ID
            FROM   pms_mnts_mng
            WHERE  BKUP_ID = '0000000000'
            AND    PRJT_ID      = #{prjt_id}
        </selectKey>

        INSERT INTO pms_mnts_mng
        (
        BKUP_ID
        ,PRJT_ID
        ,MNG_ID
        ,CNF_WEK
        ,MTN_DT
        ,MTN_TM
        ,MTN_PLC
        ,ATHR_NO
        ,MTN_DTL
        ,MTN_RSL
        ,RQS_DTL
        ,ATND_DTL
        ,ATFL_MNG_ID
        ,DEL_YN
        ,OPR_NO
        ,DB_CHG_TS
        )
        VALUES
        (
        '0000000000'
        , #{prjt_id}
        , #{mng_id}
        , #{cnf_wek}
        , REPLACE(#{mtn_dt}, '-', '')
        , #{mtn_tm}
        , #{mtn_plc}
        , #{athr_no}
        , #{mtn_dtl}
        , #{mtn_rsl}
        , #{rqs_dtl}
        , #{atnd_dtl}
        , ''
        , 'N'
        , #{login_emp_no}
        , DATE_FORMAT(NOW(),'%Y%m%d%H%i%s')
        )
  </insert>
</mapper>
